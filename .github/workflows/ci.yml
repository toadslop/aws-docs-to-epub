name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

        steps:
            - uses: actions/checkout@v3

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libcairo2-dev

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: Lint with pylint
              run: |
                  pylint src/aws_docs_to_epub --disable=all --enable=E,F
              continue-on-error: true

            - name: Format check with black
              run: |
                  black --check src tests
              continue-on-error: true

            - name: Import sort check
              run: |
                  isort --check-only src tests
              continue-on-error: true

            - name: Type check with mypy
              run: |
                  mypy src
              continue-on-error: true

            - name: Test with pytest
              run: |
                  pytest --cov=aws_docs_to_epub --cov-report=xml

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage.xml
                  fail_ci_if_error: false
